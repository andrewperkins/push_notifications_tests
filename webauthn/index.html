<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WebAuthn</title>
    </head>
    <body>
        <h1>Register</h1>
        <form id="register" onsubmit="register(event)">
            <fieldset>
                <label for="username">username</label>
                <input type="text" name="username" id="username" />
                <input class="button-primary" type="submit" value="Register" />
            </fieldset>
        </form>

        <!-- <h1>Sign In</h1>
        <input type="button" value="Sign In" onclick="signIn()" />

        <h1>Sign Out</h1>
        <input type="button" value="Sign Out" onclick="signOut()" /> -->

        <script>
            async function register(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                let query = '?user_name=' + username;

                const registrationResponse = await fetch('/register' + query, {
                    method: 'GET',
                });

                if (!registrationResponse.ok) {
                    const error = registrationResponse.json().error;
                    console.error(error);
                    return;
                }

                let options = await registrationResponse.json();
                console.log(options);
                options = makeCredReqFormat(options);
                console.log(options);

                const credential = await navigator.credentials.create({
                    publicKey: options,
                });

                console.log(credential);

                const registrationResponseFinal = await fetch(
                    '/register_final',
                    {
                        method: 'POST',
                        body: JSON.stringify(credential),
                    }
                );

                if (!registrationResponseFinal.ok) {
                    const error = (await registrationResponseFinal.json())
                        .error;
                    console.error(error);
                    return;
                }
                alert('Registration successful');
            }

            function makeCredReqFormat(makeCredReq) {
                makeCredReq.challenge = base64url.decode(makeCredReq.challenge);
                makeCredReq.user.id = base64url.decode(makeCredReq.user.id);

                return makeCredReq;
            }

            (function () {
                'use strict';

                var chars =
                    'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';

                // Use a lookup table to find the index.
                var lookup = new Uint8Array(256);
                for (var i = 0; i < chars.length; i++) {
                    lookup[chars.charCodeAt(i)] = i;
                }

                var encode = function (arraybuffer) {
                    var bytes = new Uint8Array(arraybuffer),
                        i,
                        len = bytes.length,
                        base64 = '';

                    for (i = 0; i < len; i += 3) {
                        base64 += chars[bytes[i] >> 2];
                        base64 +=
                            chars[((bytes[i] & 3) << 4) | (bytes[i + 1] >> 4)];
                        base64 +=
                            chars[
                                ((bytes[i + 1] & 15) << 2) | (bytes[i + 2] >> 6)
                            ];
                        base64 += chars[bytes[i + 2] & 63];
                    }

                    if (len % 3 === 2) {
                        base64 = base64.substring(0, base64.length - 1);
                    } else if (len % 3 === 1) {
                        base64 = base64.substring(0, base64.length - 2);
                    }

                    return base64;
                };

                var decode = function (base64) {
                    var bufferLength = base64.length * 0.75,
                        len = base64.length,
                        i,
                        p = 0,
                        encoded1,
                        encoded2,
                        encoded3,
                        encoded4;

                    var arraybuffer = new ArrayBuffer(bufferLength),
                        bytes = new Uint8Array(arraybuffer);

                    for (i = 0; i < len; i += 4) {
                        encoded1 = lookup[base64.charCodeAt(i)];
                        encoded2 = lookup[base64.charCodeAt(i + 1)];
                        encoded3 = lookup[base64.charCodeAt(i + 2)];
                        encoded4 = lookup[base64.charCodeAt(i + 3)];

                        bytes[p++] = (encoded1 << 2) | (encoded2 >> 4);
                        bytes[p++] = ((encoded2 & 15) << 4) | (encoded3 >> 2);
                        bytes[p++] = ((encoded3 & 3) << 6) | (encoded4 & 63);
                    }

                    return arraybuffer;
                };

                /**
                 * Exporting and stuff
                 */
                if (
                    typeof module !== 'undefined' &&
                    typeof module.exports !== 'undefined'
                ) {
                    module.exports = {
                        encode: encode,
                        decode: decode,
                    };
                } else {
                    if (typeof define === 'function' && define.amd) {
                        define([], function () {
                            return {
                                encode: encode,
                                decode: decode,
                            };
                        });
                    } else {
                        window.base64url = {
                            encode: encode,
                            decode: decode,
                        };
                    }
                }
            })();
        </script>
    </body>
</html>
